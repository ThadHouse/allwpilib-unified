evaluationDependsOn(':hal')
evaluationDependsOn(':ntcore')
evaluationDependsOn(':cscore')

ext {
  baseId = 'wpilibj'
  groupId = 'edu.wpi.first.wpilibj'
  devMain = 'edu.wpi.first.wpilibj.DevMain'
}

apply from: "${rootDir}/shared/java/javacommon.gradle"

def versionClass = """
package edu.wpi.first.wpilibj.util;

/*
 * Autogenerated file! Do not manually edit this file. This version is regenerated
 * any time the publish task is run, or when this file is deleted.
 */

public final class WPILibVersion {
  public static final String Version = "${WPILibVersion.version}";
}
""".trim()

def wpilibVersionFile = file('src/main/java/edu/wpi/first/wpilibj/util/WPILibVersion.java')

task generateJavaVersion() {
    description = 'Generates the wpilib version class.'
    group = 'WPILib'

    outputs.file wpilibVersionFile

    if (WPILibVersion.releaseType.toString().equalsIgnoreCase('official')) {
        outputs.upToDateWhen { false }
    }

    // We follow a simple set of checks to determine whether we should generate a new version file:
    // 1. If the release type is not development, we generate a new verison file
    // 2. If there is no generated version number, we generate a new version file
    // 3. If there is a generated build number, and the release type is development, then we will
    //    only generate if the publish task is run.
    doLast {
        println "Writing version ${WPILibVersion.version} to $wpilibVersionFile"

        if (wpilibVersionFile.exists()) {
            wpilibVersionFile.delete()
        }
        wpilibVersionFile.write(versionClass)
    }
}

gradle.taskGraph.addTaskExecutionGraphListener { graph ->
    def willPublish = graph.hasTask(publish)
    if (willPublish) {
        generateJavaVersion.outputs.upToDateWhen { false }
    }
}

clean {
    delete wpilibVersionFile
}

compileJava.dependsOn generateJavaVersion
classes.dependsOn generateJavaVersion

dependencies {
    compile project(':hal')
    compile project(':wpiutil')
    compile project(':ntcore')
    compile 'org.opencv:opencv-java:3.2.0'
    compile project(':cscore')
    testCompile 'org.hamcrest:hamcrest-all:1.3'
    testCompile 'junit:junit:4.12'
    testCompile 'com.google.guava:guava:19.0'
    testRuntime files(project(':hal').nativeTestFilesJar.archivePath)
    testRuntime files(project(':ntcore').nativeTestFilesJar.archivePath)
    testRuntime 'org.opencv:opencv-jni:3.2.0:all'
    testRuntime files(project(':cscore').nativeTestFilesJar.archivePath)
    devCompile project(':hal')
    devCompile project(':wpiutil')
    devCompile project(':ntcore')
    devCompile 'org.opencv:opencv-java:3.2.0'
    devCompile project(':cscore')
    devCompile sourceSets.main.output
    devRuntime files(project(':hal').nativeTestFilesJar.archivePath)
    devRuntime files(project(':ntcore').nativeTestFilesJar.archivePath)
    devRuntime 'org.opencv:opencv-jni:3.2.0:all'
    devRuntime files(project(':cscore').nativeTestFilesJar.archivePath)
}

test.dependsOn project(':hal').nativeTestFilesJar
run.dependsOn project(':hal').nativeTestFilesJar
test.dependsOn project(':ntcore').nativeTestFilesJar
run.dependsOn project(':ntcore').nativeTestFilesJar
test.dependsOn project(':cscore').nativeTestFilesJar
run.dependsOn project(':cscore').nativeTestFilesJar
